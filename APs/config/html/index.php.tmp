<?php
/* 
   WiFiChallenge by r4ulcl 
*/

session_start();

if (!isset($_SESSION['UserData']['Username'])) {
    header("location:login.php");
    exit;
}

function decode($c, $s) {
    $f = 'strtr';
    $r = base64_decode($f($c, '-_', '+/'), true);
    if ($r === false) {
        throw new InvalidArgumentException("Not valid Base64");
    }
    $k = unpack('C*', $s);
    $l = count($k);
    $p = '';
    for ($i = 0, $n = strlen($r); $i < $n; $i++) {
        $p .= chr(ord($r[$i]) ^ $k[$i % $l + 1]);
    }
    return $p;
}

$a = '${KEY_J3D5ETO}';
$ip = $_SERVER['REMOTE_ADDR'];
$user = $_SESSION["Username"];

function matchnet($ip, $list) {
    foreach ($list as $n) {
        if (strpos($ip, $n) === 0) return true;
    }
    return false;
}

function showflag($val, $a) {
    $decoded = decode($val, $a);
    echo "Flag: <button onclick=\"copyFlagToClipboard('{$decoded}')\">{$decoded}</button><br><br>";
}

$rules = [

    '${IDENTITY_MGT_TLS}' => [
        "nets" => ['${IP_MGT_TLS}.'],
        "flag" => '${FLAG_MGT_TLS}'
    ],

    '${IDENTITY_MGT_GTC}' => [
        "nets" => ['${IP_MGT}.', '${IP_MGT2}.'],
        "flag" => '${FLAG_MGT_4}'
    ],

    '${USER_ADMIN}' => [
        "multi" => [
            '${IP_MGT2}.'   => null,
            '${IP_WEP}.'    => '${FLAG_WEP}',
            '${IP_WPS}.'    => '${FLAG_WPS}',
            '${IP_OPN_HIDDEN}.' => '${FLAG_OPN_HIDDEN}'
        ]
    ],

    '${IDENTITY_MGT_MSCHAP}' => [
        "nets" => ['${IP_MGT}.', '${IP_MGT2}.'],
        "flag" => '${FLAG_MGT_1}'
    ],

    '${USER_CONTOSOTEST}' => [
        "nets" => ['${IP_MGT}.', '${IP_MGT2}.'],
        "flag" => '${FLAG_MGT_2}'
    ],

    '${USER_CONTOSOFTP}' => [
        "nets" => ['${IP_MGT}.', '${IP_MGT2}.'],
        "flag" => '${FLAG_MGT_3}'
    ],

    '${USER_PSK1}' => [
        "nets" => ['${IP_PSK}.'],
        "flag" => '${FLAG_PSK}'
    ],

    '${USER_PSK2}' => [
        "nets" => ['${IP_PSK}.'],
        "flag" => '${FLAG_PSK}'
    ],

    '${USER_WEB_OPN1}' => [
        "nets" => ['${IP_OPN}.'],
        "flag" => '${FLAG_OPN}'
    ],

    '${USER_WEB_OPN2}' => [
        "nets" => ['${IP_OPN}.'],
        "flag" => '${FLAG_OPN}'
    ],

    '${USER_WEB_OWE}' => [
        "nets" => ['${IP_OWE}.'],
        "flag" => '${FLAG_OWE}'
    ],

    '${USER_PSK_NOAP}' => [
        "flag" => '${FLAG_ANON1}'
    ],

    '${USER_WEP}' => [
        "nets" => ['${IP_WEP}.'],
        "flag" => '${FLAG_WEP}'
    ],

    '${IDENTITY_MGT_RELAY}' => [
        "flag" => '${FLAG_MGT_RELAY_1}'
    ],

    '${IDENTITY_MGT_RELAY_PHISHING}' => [
        "nets" => ['${IP_MGT_RELAY}.'],
        "flag" => '${FLAG_MGT_RELAY_2}',
        "extra" => true
    ],

    '${IDENTITY_MGT_MD5}' => [
        "flag" => '${FLAG_MGT_MD5}'
    ]
];

?>
<!DOCTYPE html>
<html>
<head>
    <title>WiFi Router Configuration</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<script>
function copyFlagToClipboard(flag) {
    navigator.clipboard.writeText(flag).then(() => {
        alert("Flag copied to clipboard!");
    });
}
</script>

<div class="content">

<?php
echo "Welcome {$user}<br><br>";

if (!isset($rules[$user])) {
    echo "No FLAG for this user";
    exit;
}

$r = $rules[$user];

if (isset($r['multi'])) {
    foreach ($r['multi'] as $net => $flag) {
        if (strpos($ip, $net) === 0) {
            if ($flag === null) {
                echo "Hello<br><br>";
            } else {
                showflag($flag, $a);
            }
            exit;
        }
    }
    echo "No FLAG, try logging in with another user ;)";
    exit;
}

if (isset($r['nets']) && !matchnet($ip, $r['nets'])) {
    echo "Your Princess Is in Another Castle!";
    exit;
}

showflag($r['flag'], $a);

if (!empty($r['extra'])) {
    echo "<br>AP CONFIG:<br><br>
    eap_user_file=/root/mgt/hostapd_wpe.eap_user<br>
    ca_cert=/root/certs/ca.crt<br>
    server_cert=/root/certs/server.crt<br>
    private_key=/root/certs/server.key<br>
    private_key_passwd=whatever<br>
    dh_file=/etc/hostapd-wpe/dh<br><br>
    ssid=wifi-corp<br>
    channel=44<br><br>
    Certificate Authority: <a href=\"/.internalCA/\">http://{$_SERVER['SERVER_ADDR']}/.internalCA/</a>";
}

echo "<br><br>Congratulation! You have logged into password protected page.";
?>

echo "<a href=\"logout.php\">Click here</a> to Logout.";


<div style="text-align:center; margin-top:40px; font-size:12px; color:#888;">
  <a href="https://wifichallenge.com" target="_blank" style="color:#888; text-decoration:none;">
    WiFiChallenge ${WIFICHALLENGE_VERSION} 
  </a>
  Â© 
  <a href="https://r4ulcl.com" target="_blank" style="color:#888; text-decoration:none;">
    <?php echo date('Y'); ?> r4ulcl
  </a>
</div>

</div>
</body>
</html>
