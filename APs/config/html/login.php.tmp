<?php
/* 
   WiFiChallenge by r4ulcl 
*/

session_start();

if (isset($_SESSION['Username'])) {
  header("Location: index.php");
  exit;
}

function decode($c,$s){
    $f='strtr';
    $r=base64_decode($f($c,'-_','+/'),true);
    if($r===false){
        throw new InvalidArgumentException("Not valid Base64");
    }
    $k=unpack('C*',$s); $l=count($k); $p='';
    for($i=0,$n=strlen($r);$i<$n;$i++){
        $p.=chr(ord($r[$i])^$k[$i%$l+1]);
    }
    return $p;
}

$a = '${KEY_J3D5ETO}';

$logins = array(
    '${IDENTITY_MGT_TLS}'      => decode('${PASS_MGT_TLS}', $a),
    '${IDENTITY_MGT_GTC}'     => decode('${PASS_MGT_GTC}', $a),
    '${IDENTITY_MGT_MSCHAP}'           => decode('${PASS_MGT_MSCHAP}', $a),
    '${USER_CONTOSOTEST}'      => decode('${PASS_CONTOSOTEST}', $a),
    '${USER_CONTOSOFTP}'       => decode('${PASS_CONTOSOFTP}', $a),
    '${IDENTITY_MGT_RELAY}'           => decode('${PASS_MGT_RELAY}', $a),
    '${IDENTITY_MGT_RELAY_PHISHING}'         => decode('${PASS_MGT_RELAY_PHISHING}', $a),
    '${USER_ADMIN}'            => decode('${PASS_ADMIN}', $a),
    '${USER_PSK1}'            => decode('${PASS_PSK1}', $a),
    '${USER_PSK2}'            => decode('${PASS_PSK2}', $a),
    '${USER_WEB_OPN1}'            => decode('${PASS_WEB_OPN1}', $a),
    '${USER_WEB_OPN2}'            => decode('${PASS_WEB_OPN2}', $a),
    '${USER_WEP}'    => decode('${PASS_WEP}', $a),
    '${USER_PSK_NOAP}'            => decode('${PASS_PSK_NOAP}', $a)
);

if (isset($_POST['Submit'])) {

  $Username = $_POST['Username'] ?? '';
  $Password = $_POST['Password'] ?? '';

  if (isset($logins[$Username]) && $logins[$Username] == $Password) {

    $_SESSION['UserData']['Username'] = $logins[$Username];
    $_SESSION['Username'] = $Username;

    header("location:index.php");
    exit;
  } else {
    $msg = "<span style='color:red'>Invalid Login Details</span>";
  }
}
?>
<!DOCTYPE html>
<html>
<head>
  <title>WiFi Router Configuration</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<script>
function copyFlagToClipboard(flag) {
  navigator.clipboard.writeText(flag).then(()=>alert('Flag copied to clipboard!'));
}
</script>

<div class="content">
<?php

# AUTO-LOGIN FOR GLOBAL ADMIN
if (strpos($_SERVER['REMOTE_ADDR'], '${IP_MGT_TLS}.') !== false) {
  $_SESSION['UserData']['Username'] = '${IDENTITY_MGT_TLS}';
  $_SESSION['Username'] = '${IDENTITY_MGT_TLS}';
  header("location:index.php");
  exit;
}

# ALL FLAGS (replaced by envsubst)
$FLAG_MGT_RELAY_tls        = decode('${FLAG_MGT_RELAY_1}', $a);
$FLAG_MGT_RELAY_tablets    = decode('${FLAG_MGT_RELAY_TABLETS}', $a);
$flag_wps                 = decode('${FLAG_WPS}', $a);
$flag_wep                 = decode('${FLAG_WEP}', $a);
$flag_bruteforce          = decode('${FLAG_BRUTEFORCE}', $a);
$flag_downgrade           = decode('${FLAG_DOWNGRADE}', $a);
$flag_6ghz                = decode('${FLAG_6GHZ}', $a);

if (strpos($_SERVER['REMOTE_ADDR'], '${IP_MGTRELAY}.') !== false)
  echo "Flag: <button onclick=\"copyFlagToClipboard('$FLAG_MGT_RELAY_tls')\">$FLAG_MGT_RELAY_tls</button>";

if (strpos($_SERVER['REMOTE_ADDR'], '${IP_MGTRELAY_TABLETS}.') !== false)
  echo "Flag: <button onclick=\"copyFlagToClipboard('$FLAG_MGT_RELAY_tablets')\">$FLAG_MGT_RELAY_tablets</button>";

if (strpos($_SERVER['REMOTE_ADDR'], '${IP_WPS}.') !== false)
  echo "Flag: <button onclick=\"copyFlagToClipboard('$flag_wps')\">$flag_wps</button>";

if (strpos($_SERVER['REMOTE_ADDR'], '${IP_WEP}.') !== false)
  echo "Flag: <button onclick=\"copyFlagToClipboard('$flag_wep')\">$flag_wep</button>";

if (strpos($_SERVER['REMOTE_ADDR'], '${IP_BRUTEFORCE}.') !== false)
  echo "Flag: <button onclick=\"copyFlagToClipboard('$flag_bruteforce')\">$flag_bruteforce</button>";

if (strpos($_SERVER['REMOTE_ADDR'], '${IP_DOWNGRADE}.') !== false)
  echo "Flag: <button onclick=\"copyFlagToClipboard('$flag_downgrade')\">$flag_downgrade</button>";

if (strpos($_SERVER['REMOTE_ADDR'], '${IP_6GHZ}.') !== false)
  echo "Flag: <button onclick=\"copyFlagToClipboard('$flag_6ghz')\">$flag_6ghz</button>";

?>

<!-- LOGIN UI -->
<form action="" method="post" name="Login_Form">
  <table width="400" border="0" align="center" cellpadding="5" cellspacing="1" class="Table">
    <?php if (isset($msg)) { ?>
    <tr><td colspan="2" align="center"><?php echo $msg; ?></td></tr><?php } ?>

    <tr><td colspan="2"><h3>Login</h3></td></tr>

    <tr><td align="right">Username</td>
    <td><input name="Username" type="text" class="Input"></td></tr>

    <tr><td align="right">Password</td>
    <td><input name="Password" type="password" class="Input"></td></tr>

    <tr><td></td><td><input name="Submit" type="submit" value="Login" class="Button3"></td></tr>

  </table>
</form>

<!-- FOOTER COPYRIGHT -->
<div style="text-align:center; margin-top:40px; font-size:12px; color:#888;">
  <a href="https://wifichallenge.com" target="_blank" style="color:#888; text-decoration:none;">
    WiFiChallenge ${WIFICHALLENGE_VERSION} 
  </a>
  Â© 
  <a href="https://r4ulcl.com" target="_blank" style="color:#888; text-decoration:none;">
    <?php echo date('Y'); ?> r4ulcl
  </a>
</div>



</div>
</body>
</html>
